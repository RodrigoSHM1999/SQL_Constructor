{% extends 'base.html' %}

{% block title %}Editar Consulta - {{ query.nombre }}{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
    
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="flex justify-between items-start">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">
                    <i class="fas fa-edit"></i> Editar Consulta: {{ query.nombre }}
                </h1>
                <p class="text-gray-600 mt-2">Modifica la configuración de la consulta SQL</p>
            </div>
            <a href="{% url 'queries:technical_query_detail' query.pk %}" class="btn-secondary">
                <i class="fas fa-arrow-left"></i> Cancelar
            </a>
        </div>
    </div>
    
    <!-- Formulario -->
    <form method="POST" class="space-y-6">
        {% csrf_token %}
        
        <!-- Información básica -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">
                <i class="fas fa-info-circle"></i> Información Básica
            </h2>
            
            <div class="space-y-4">
                <div>
                    <label for="nombre" class="block text-sm font-medium text-gray-700 mb-2">
                        Nombre de la Consulta <span class="text-red-500">*</span>
                    </label>
                    <input type="text" 
                           id="nombre" 
                           name="nombre" 
                           required
                           value="{{ query.nombre }}"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                           placeholder="Ej: Catálogo de Precios">
                </div>
                
                <div>
                    <label for="descripcion" class="block text-sm font-medium text-gray-700 mb-2">
                        Descripción
                    </label>
                    <textarea id="descripcion" 
                              name="descripcion" 
                              rows="3"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                              placeholder="Describe qué hace esta consulta...">{{ query.descripcion }}</textarea>
                </div>
                
                <div class="flex items-center">
                    <input type="checkbox" 
                           id="activa" 
                           name="activa" 
                           {% if query.activa %}checked{% endif %}
                           class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label for="activa" class="ml-2 text-sm font-medium text-gray-700">
                        Consulta activa (visible para usuarios finales)
                    </label>
                </div>
            </div>
        </div>
        
        <!-- SELECT Clause -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">
                <i class="fas fa-columns"></i> Cláusula SELECT
            </h2>
            <p class="text-sm text-gray-600 mb-4">
                Define los campos a seleccionar. Usa <code class="bg-gray-100 px-2 py-1 rounded">AS</code> para alias.
            </p>
            
            <textarea id="select_clause" 
                      name="select_clause" 
                      rows="4"
                      required
                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 font-mono text-sm"
                      placeholder="a.Nombre AS Producto, p.PrecioUnitario AS Precio">{{ query.select_clause }}</textarea>
        </div>
        
        <!-- FROM Clause -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">
                <i class="fas fa-database"></i> Cláusula FROM (con JOINS)
            </h2>
            <p class="text-sm text-gray-600 mb-4">
                Define la tabla base y los JOINS necesarios.
            </p>
            
            <textarea id="from_clause" 
                      name="from_clause" 
                      rows="6"
                      required
                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 font-mono text-sm"
                      placeholder="FROM dbo.Precios AS p&#10;INNER JOIN dbo.Articulos AS a ON p.id_articulo = a.id">{{ query.from_clause }}</textarea>
            
            <!-- Preview de FROM -->
            <div id="from_preview" class="mt-4 p-4 bg-gray-50 rounded-lg hidden">
                <h3 class="font-semibold text-gray-700 mb-2">Vista Previa:</h3>
                <div id="from_preview_content"></div>
            </div>
        </div>
        
        <!-- WHERE Clause -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">
                <i class="fas fa-filter"></i> Cláusula WHERE (Parámetros)
            </h2>
            <p class="text-sm text-gray-600 mb-4">
                Define filtros con parámetros dinámicos usando <code class="bg-gray-100 px-2 py-1 rounded">%1</code>, <code class="bg-gray-100 px-2 py-1 rounded">%2</code>, etc.
                <br>Puedes incluir <code class="bg-gray-100 px-2 py-1 rounded">GROUP BY</code> y <code class="bg-gray-100 px-2 py-1 rounded">ORDER BY</code> aquí.
            </p>
            
            <textarea id="where_clause" 
                      name="where_clause" 
                      rows="5"
                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 font-mono text-sm"
                      placeholder="campo1 = %1 AND campo2 > %2&#10;GROUP BY campo1&#10;ORDER BY campo1 DESC">{{ query.where_clause }}</textarea>
            
            <!-- Parámetros detectados -->
            <div id="parameters_section" class="mt-4 {% if not parametros %}hidden{% endif %}">
                <h3 class="font-semibold text-gray-700 mb-3">Configurar Parámetros:</h3>
                <div id="parameters_list" class="space-y-4">
                    {% for param in parametros %}
                    <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                        <h4 class="font-semibold text-gray-700 mb-3 flex items-center">
                            <span class="bg-blue-500 text-white px-2 py-1 rounded text-xs mr-2">%{{ param.posicion_where }}</span>
                            Parámetro {{ param.posicion_where }}
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="form-label">Nombre Interno</label>
                                <input type="text" name="param_{{ param.posicion_where }}_nombre" 
                                       class="form-control" 
                                       value="{{ param.nombre_interno }}">
                            </div>
                            <div>
                                <label class="form-label">Etiqueta Usuario</label>
                                <input type="text" name="param_{{ param.posicion_where }}_etiqueta" 
                                       class="form-control" 
                                       value="{{ param.etiqueta_usuario }}">
                            </div>
                            <div>
                                <label class="form-label">Tipo de Dato</label>
                                <select name="param_{{ param.posicion_where }}_tipo" class="form-control">
                                    <option value="texto" {% if param.tipo_dato == 'texto' %}selected{% endif %}>Texto</option>
                                    <option value="numero" {% if param.tipo_dato == 'numero' %}selected{% endif %}>Número</option>
                                    <option value="decimal" {% if param.tipo_dato == 'decimal' %}selected{% endif %}>Decimal</option>
                                    <option value="fecha" {% if param.tipo_dato == 'fecha' %}selected{% endif %}>Fecha</option>
                                    <option value="boolean" {% if param.tipo_dato == 'boolean' %}selected{% endif %}>Sí/No</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">Orden</label>
                                <input type="number" name="param_{{ param.posicion_where }}_orden" 
                                       value="{{ param.orden }}" 
                                       class="form-control">
                            </div>
                            <div>
                                <label class="form-label">Placeholder</label>
                                <input type="text" name="param_{{ param.posicion_where }}_placeholder" 
                                       class="form-control" 
                                       value="{{ param.placeholder }}">
                            </div>
                            <div>
                                <label class="form-label">Valor por Defecto</label>
                                <input type="text" name="param_{{ param.posicion_where }}_default" 
                                       class="form-control"
                                       value="{{ param.valor_por_defecto }}">
                            </div>
                            <div class="col-span-2 flex gap-6">
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="checkbox" name="param_{{ param.posicion_where }}_visible" 
                                           {% if param.visible %}checked{% endif %}
                                           class="w-4 h-4 text-blue-600 border-gray-300 rounded">
                                    <span class="ml-2 text-sm text-gray-700">Visible para usuario</span>
                                </label>
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="checkbox" name="param_{{ param.posicion_where }}_requerido"
                                           {% if param.requerido %}checked{% endif %}
                                           class="w-4 h-4 text-blue-600 border-gray-300 rounded">
                                    <span class="ml-2 text-sm text-gray-700">Campo obligatorio</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- Botones -->
        <div class="flex gap-4">
            <button type="submit" class="btn-primary">
                <i class="fas fa-save"></i> Guardar Cambios
            </button>
            <a href="{% url 'queries:technical_query_detail' query.pk %}" class="btn-secondary">
                <i class="fas fa-times"></i> Cancelar
            </a>
        </div>
    </form>
    
</div>

{% block extra_js %}
<script src="{% load static %}{% static 'js/query_builder.js' %}"></script>
<script>
// Detectar parámetros al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    detectParameters();
});
</script>
{% endblock %}
{% endblock %}