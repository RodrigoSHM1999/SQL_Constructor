{% extends 'base.html' %}

{% block title %}Crear Consulta - Técnico{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
    
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h1 class="text-3xl font-bold text-gray-800">
            <i class="fas fa-plus-circle"></i> Crear Nueva Consulta SQL
        </h1>
        <p class="text-gray-600 mt-2">Define una consulta SQL dinámica con parámetros configurables</p>
    </div>
    
    <!-- Formulario -->
    <form method="POST" class="space-y-6">
        {% csrf_token %}
        
        <!-- Información básica -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">
                <i class="fas fa-info-circle"></i> Información Básica
            </h2>
            
            <div class="space-y-4">
                <div>
                    <label for="nombre" class="block text-sm font-medium text-gray-700 mb-2">
                        Nombre de la Consulta <span class="text-red-500">*</span>
                    </label>
                    <input type="text" 
                           id="nombre" 
                           name="nombre" 
                           required
                           value="{{ form_data.nombre }}"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                           placeholder="Ej: Catálogo de Precios">
                </div>
                
                <div>
                    <label for="descripcion" class="block text-sm font-medium text-gray-700 mb-2">
                        Descripción
                    </label>
                    <textarea id="descripcion" 
                              name="descripcion" 
                              rows="3"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                              placeholder="Describe qué hace esta consulta...">{{ form_data.descripcion }}</textarea>
                </div>
                
                <div class="flex items-center">
                    <input type="checkbox" 
                           id="activa" 
                           name="activa" 
                           {% if not form_data or form_data.activa %}checked{% endif %}
                           class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label for="activa" class="ml-2 text-sm font-medium text-gray-700">
                        Consulta activa (visible para usuarios finales)
                    </label>
                </div>
            </div>
        </div>
        
        <!-- SELECT Clause -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">
                <i class="fas fa-columns"></i> Cláusula SELECT
            </h2>
            <p class="text-sm text-gray-600 mb-4">
                Define los campos a seleccionar. Usa <code class="bg-gray-100 px-2 py-1 rounded">AS</code> para alias.
            </p>
            
            <textarea id="select_clause" 
                      name="select_clause" 
                      rows="4"
                      required
                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 font-mono text-sm"
                      placeholder="a.Nombre AS Producto, p.PrecioUnitario AS Precio, l.NombreLinea AS Linea">{{ form_data.select_clause }}</textarea>
        </div>
        
        <!-- FROM Clause -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">
                <i class="fas fa-database"></i> Cláusula FROM (con JOINS)
            </h2>
            <p class="text-sm text-gray-600 mb-4">
                Define la tabla base y los JOINS necesarios.
            </p>
            
            <textarea id="from_clause" 
                      name="from_clause" 
                      rows="6"
                      required
                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 font-mono text-sm"
                      placeholder="FROM dbo.Precios AS p&#10;INNER JOIN dbo.Articulos AS a ON p.id_articulo = a.id&#10;LEFT JOIN dbo.Lineas AS l ON a.id_linea = l.id">{{ form_data.from_clause }}</textarea>
            
            <!-- Preview de FROM -->
            <div id="from_preview" class="mt-4 p-4 bg-gray-50 rounded-lg hidden">
                <h3 class="font-semibold text-gray-700 mb-2">Vista Previa:</h3>
                <div id="from_preview_content"></div>
            </div>
        </div>
        
        <!-- WHERE Clause -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">
                <i class="fas fa-filter"></i> Cláusula WHERE (Parámetros)
            </h2>
            <p class="text-sm text-gray-600 mb-4">
                Define filtros con parámetros dinámicos usando <code class="bg-gray-100 px-2 py-1 rounded">%1</code>, <code class="bg-gray-100 px-2 py-1 rounded">%2</code>, etc.
            </p>
            
            <textarea id="where_clause" 
                      name="where_clause" 
                      rows="3"
                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 font-mono text-sm"
                      placeholder="a.Estado = %1 AND p.PrecioUnitario > %2">{{ form_data.where_clause }}</textarea>
            
            <!-- Parámetros detectados -->
            <div id="parameters_section" class="mt-4 hidden">
                <h3 class="font-semibold text-gray-700 mb-3">Configurar Parámetros:</h3>
                <div id="parameters_list" class="space-y-4"></div>
            </div>
        </div>
        
        <!-- Botones -->
        <div class="flex gap-4">
            <button type="submit" class="btn-primary">
                <i class="fas fa-save"></i> Guardar Consulta
            </button>
            <a href="{% url 'queries:technical_query_list' %}" class="btn-secondary">
                <i class="fas fa-times"></i> Cancelar
            </a>
        </div>
    </form>
    
</div>

{% block extra_js %}
<script>
// Detectar parámetros en WHERE y generar formulario dinámico
document.getElementById('where_clause').addEventListener('blur', function() {
    const whereText = this.value;
    const paramRegex = /%(\d+)/g;
    const matches = [...whereText.matchAll(paramRegex)];
    const uniqueParams = [...new Set(matches.map(m => parseInt(m[1])))].sort((a, b) => a - b);
    
    if (uniqueParams.length > 0) {
        document.getElementById('parameters_section').classList.remove('hidden');
        const paramsList = document.getElementById('parameters_list');
        paramsList.innerHTML = '';
        
        uniqueParams.forEach(param => {
            paramsList.innerHTML += generateParameterForm(param);
        });
    } else {
        document.getElementById('parameters_section').classList.add('hidden');
    }
});

function generateParameterForm(paramNum) {
    return `
        <div class="border border-gray-200 rounded-lg p-4">
            <h4 class="font-semibold text-gray-700 mb-3">Parámetro %${paramNum}</h4>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nombre Interno</label>
                    <input type="text" name="param_${paramNum}_nombre" 
                           class="w-full px-3 py-2 border border-gray-300 rounded" 
                           placeholder="parametro_${paramNum}">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Etiqueta Usuario</label>
                    <input type="text" name="param_${paramNum}_etiqueta" 
                           class="w-full px-3 py-2 border border-gray-300 rounded" 
                           placeholder="Parámetro ${paramNum}">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Dato</label>
                    <select name="param_${paramNum}_tipo" class="w-full px-3 py-2 border border-gray-300 rounded">
                        <option value="texto">Texto</option>
                        <option value="numero">Número</option>
                        <option value="decimal">Decimal</option>
                        <option value="fecha">Fecha</option>
                        <option value="boolean">Sí/No</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Orden</label>
                    <input type="number" name="param_${paramNum}_orden" 
                           value="${paramNum}" 
                           class="w-full px-3 py-2 border border-gray-300 rounded">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Placeholder</label>
                    <input type="text" name="param_${paramNum}_placeholder" 
                           class="w-full px-3 py-2 border border-gray-300 rounded" 
                           placeholder="Texto de ayuda">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Valor por Defecto</label>
                    <input type="text" name="param_${paramNum}_default" 
                           class="w-full px-3 py-2 border border-gray-300 rounded">
                </div>
                <div class="col-span-2 space-x-4">
                    <label class="inline-flex items-center">
                        <input type="checkbox" name="param_${paramNum}_visible" checked
                               class="w-4 h-4 text-blue-600 border-gray-300 rounded">
                        <span class="ml-2 text-sm text-gray-700">Visible</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="checkbox" name="param_${paramNum}_requerido"
                               class="w-4 h-4 text-blue-600 border-gray-300 rounded">
                        <span class="ml-2 text-sm text-gray-700">Obligatorio</span>
                    </label>
                </div>
            </div>
        </div>
    `;
}
</script>
{% endblock %}
{% endblock %}